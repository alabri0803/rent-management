# ✅ نموذج إلغاء عقد الإيجار مع اختيار الأسباب

## 🎯 الميزة الجديدة

تم إضافة **نموذج تفاعلي احترافي** لإلغاء عقد الإيجار مع إمكانية اختيار سبب الإلغاء من **6 أسباب محددة مسبقاً**.

---

## 📋 أسباب الإلغاء المتاحة

| الأيقونة | السبب | الوصف |
|---------|-------|-------|
| 📅 | **انتهاء المدة المحددة في العقد** | العقد انتهى بشكل طبيعي |
| 💰 | **عدم دفع الإيجار لأكثر من شهرين متتاليين** | تأخر في السداد |
| ⚠️ | **مخالفة شروط العقد من قبل المستأجر** | انتهاك بنود العقد |
| 🏠 | **رغبة المالك في استرداد العقار** | المالك يريد استرجاع العقار |
| 👤 | **رغبة المستأجر في إنهاء العقد** | طلب من المستأجر |
| 📝 | **أسباب أخرى** | يمكن التوضيح في التفاصيل الإضافية |

---

## 🎨 التصميم

### 1️⃣ **بطاقات تفاعلية:**
- كل سبب في بطاقة منفصلة مع أيقونة
- تأثيرات hover عند التمرير
- تحديد بصري واضح عند الاختيار
- تصميم متجاوب للموبايل والديسكتوب

### 2️⃣ **تحذير واضح:**
- رسالة تحذيرية بارزة
- توضيح أن الإجراء لا يمكن التراجع عنه
- معلومات العقد والمستأجر

### 3️⃣ **الحقول:**
```
📅 تاريخ طلب الإلغاء (تلقائي - تاريخ اليوم)
📋 سبب الإلغاء (اختيار واحد من 6 خيارات)
📝 تفاصيل إضافية وأسباب أخرى (نص حر)
```

---

## 🗄️ التغييرات في قاعدة البيانات

### 1. **حقول جديدة:**

```python
# في نموذج Lease
CANCELLATION_REASON_CHOICES = [
    ('contract_term_ended', 'انتهاء المدة المحددة في العقد'),
    ('non_payment', 'عدم دفع الإيجار لأكثر من شهرين متتاليين'),
    ('tenant_violation', 'مخالفة شروط العقد من قبل المستأجر'),
    ('owner_reclaim', 'رغبة المالك في استرداد العقار'),
    ('tenant_request', 'رغبة المستأجر في إنهاء العقد'),
    ('other', 'أسباب أخرى'),
]

cancellation_date = DateField()  # تاريخ الإلغاء
cancellation_reason = CharField(max_length=200, choices=...)  # السبب
cancellation_details = TextField()  # تفاصيل إضافية
```

### 2. **Migration:**
- ✅ `0010_add_cancellation_details_v2` - مطبق بنجاح
- ✅ حقل `cancellation_reason` محدّث من TEXT إلى VARCHAR(200)
- ✅ حقل `cancellation_details` جديد للتفاصيل الإضافية

---

## 📂 الملفات المعدلة

| الملف | التغيير |
|------|---------|
| `dashboard/models.py` | ✅ إضافة CANCELLATION_REASON_CHOICES + حقلين جديدين |
| `dashboard/forms.py` | ✅ تحديث LeaseCancelForm مع RadioSelect |
| `templates/dashboard/lease_cancel_form.html` | ✅ تصميم كامل جديد بالبطاقات |
| `dashboard/migrations/0010_add_cancellation_details_v2.py` | ✅ Migration جديد |

---

## 🚀 كيفية الاستخدام

### 1️⃣ **الوصول للنموذج:**
```
/dashboard/leases/<id>/cancel/
```

أو من صفحة تفاصيل العقد → زر "استمارة إلغاء العقد"

### 2️⃣ **ملء النموذج:**
1. تحقق من تاريخ الإلغاء (يُملأ تلقائياً بتاريخ اليوم)
2. اختر سبب الإلغاء من البطاقات
3. أضف تفاصيل إضافية إذا لزم الأمر (خاصة إذا اخترت "أسباب أخرى")
4. اضغط "تأكيد الإلغاء"

### 3️⃣ **بعد الإلغاء:**
- ✅ يتم تغيير حالة العقد إلى `cancelled`
- ✅ يتم حفظ سبب الإلغاء والتفاصيل
- ✅ يتم إنشاء استمارة إلغاء PDF تلقائياً
- ✅ تصبح الوحدة متاحة للإيجار مجدداً

---

## 💡 مثال عملي

### السيناريو:
مستأجر لم يدفع الإيجار لمدة 3 أشهر → قرر المكتب إلغاء العقد

### الخطوات:
```
1. افتح العقد المراد إلغاؤه
2. اضغط "استمارة إلغاء العقد"
3. اختر البطاقة: 💰 "عدم دفع الإيجار لأكثر من شهرين متتاليين"
4. أضف في التفاصيل: "لم يدفع المستأجر لمدة 3 أشهر رغم الإنذارات"
5. اضغط "تأكيد الإلغاء"
```

### النتيجة:
```sql
cancellation_date = 2025-10-22
cancellation_reason = 'non_payment'
cancellation_details = 'لم يدفع المستأجر لمدة 3 أشهر رغم الإنذارات'
status = 'cancelled'
```

---

## 🎨 لقطات الشاشة (الوصف)

### 📱 **الواجهة:**

```
┌────────────────────────────────────────┐
│ ⚠️  إلغاء عقد الإيجار                │
│     العقد رقم: 21053/2024             │
├────────────────────────────────────────┤
│ ⚠️ تنبيه هام:                         │
│ سيتم إلغاء العقد الخاص بالمستأجر     │
│ مسار للتنمية والتدريب                │
│ هذا الإجراء لا يمكن التراجع عنه      │
└────────────────────────────────────────┘

📅 تاريخ طلب الإلغاء: [22/10/2025]

📋 سبب الإلغاء
اختر السبب

┌──────────────┬──────────────┐
│ 📅 انتهاء   │ 💰 عدم دفع  │
│   المدة     │   الإيجار   │
└──────────────┴──────────────┘
┌──────────────┬──────────────┐
│ ⚠️ مخالفة   │ 🏠 رغبة     │
│   شروط      │   المالك    │
└──────────────┴──────────────┘
┌──────────────┬──────────────┐
│ 👤 رغبة     │ 📝 أسباب    │
│   المستأجر  │   أخرى      │
└──────────────┴──────────────┘

📝 تفاصيل إضافية وأسباب أخرى
┌────────────────────────────────┐
│ [يرجى توضيح التفاصيل...]      │
│                                │
└────────────────────────────────┘

     [↩️ تراجع]  [🗑️ تأكيد الإلغاء]
```

---

## 🔄 التكامل مع النظام

### 1. **استمارة الإلغاء PDF:**
عند الإلغاء، يتم توليد PDF يحتوي على:
- سبب الإلغاء (يُترجم من الكود إلى النص العربي)
- التفاصيل الإضافية (إن وجدت)
- الالتزامات المالية
- معلومات كاملة عن العقد

### 2. **عرض السبب:**
في صفحة تفاصيل العقد الملغي:
```html
معلومات الإلغاء:
  تاريخ الإلغاء: 22/10/2025
  سبب الإلغاء: عدم دفع الإيجار لأكثر من شهرين متتاليين
  التفاصيل: لم يدفع المستأجر لمدة 3 أشهر رغم الإنذارات
```

---

## 📊 الإحصائيات

يمكنك الآن تتبع:
- عدد العقود الملغاة حسب كل سبب
- الأسباب الأكثر شيوعاً للإلغاء
- العقود الملغاة بسبب عدم السداد
- إلخ

### مثال Query:
```python
from dashboard.models import Lease

# عدد العقود الملغاة بسبب عدم الدفع
non_payment_count = Lease.objects.filter(
    status='cancelled',
    cancellation_reason='non_payment'
).count()

print(f'العقود الملغاة بسبب عدم الدفع: {non_payment_count}')
```

---

## ✅ الفوائد

| قبل | بعد |
|-----|-----|
| ❌ حقل نص حر فقط | ✅ خيارات محددة + نص حر |
| ❌ لا توجد أسباب قياسية | ✅ 6 أسباب محددة مسبقاً |
| ❌ صعوبة التحليل | ✅ سهولة تتبع الإحصائيات |
| ❌ واجهة بسيطة | ✅ واجهة احترافية بالبطاقات |
| ❌ لا يوجد تحذير واضح | ✅ تحذير بارز قبل الإلغاء |

---

## 🔧 للمطورين

### إضافة سبب إلغاء جديد:

```python
# في dashboard/models.py
CANCELLATION_REASON_CHOICES = [
    # ... الأسباب الموجودة
    ('new_reason', _('السبب الجديد')),  # أضف هنا
]
```

### تخصيص الأيقونة:

```html
<!-- في lease_cancel_form.html -->
{% elif choice.choice_label == "السبب الجديد" %}
    🆕  <!-- غيّر الأيقونة هنا -->
{% endif %}
```

---

**التحديث:** 22 أكتوبر 2025  
**الحالة:** ✅ جاهز للاستخدام الفوري  
**التأثير:** تحسين كبير في إدارة إلغاء العقود وتتبع الأسباب

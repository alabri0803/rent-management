# دليل نظام إنذارات عدم السداد

## نظرة عامة

تم إنشاء نظام إنذارات عدم السداد ليكون متوافقاً مع القوانين العمانية ويوفر إدارة شاملة للإنذارات القانونية للمستأجرين المتأخرين في السداد.

## الميزات الرئيسية

### 1. إنشاء الإنذارات التلقائية
- **التوقيت**: يتم إنشاء الإنذارات تلقائياً بعد شهر كامل من تاريخ استحقاق الدفعة
- **الشروط**: العقود النشطة فقط مع دفعات متأخرة لأكثر من 30 يوماً
- **عدم التكرار**: لا يتم إنشاء إنذارات مكررة لنفس الشهر والسنة

### 2. الامتثال القانوني العماني
- **المدة القانونية**: 30 يوماً من تاريخ الإنذار (حسب القانون العماني)
- **المحتوى القانوني**: نصوص متوافقة مع قانون الإيجار في سلطنة عمان
- **الإجراءات المتدرجة**: إنذار → فسخ العقد → الإخلاء
- **الملاحظات القانونية**: تنبيهات مهمة حول الحقوق والواجبات

### 3. إدارة شاملة للإنذارات
- **حالات متعددة**: مسودة، مُرسل، مُستلم، محلول، مُصعد
- **تتبع التواريخ**: إرسال، استلام، حل المشكلة
- **معلومات التسليم**: طريقة التسليم وتوقيع المستلم
- **الملاحظات**: تسجيل تفاصيل المتابعة

## الاستخدام

### إنشاء الإنذارات التلقائية

#### من واجهة الويب:
1. انتقل إلى **المالية** > **إنذارات عدم السداد**
2. اضغط على **إنشاء إنذارات تلقائية**
3. راجع المعاينة للإنذارات التي سيتم إنشاؤها
4. أكد الشروط واضغط **إنشاء الإنذارات التلقائية**

#### من سطر الأوامر:
```bash
python3 manage.py generate_overdue_notices
```

**خيارات الأمر:**
- `--dry-run`: معاينة النتائج دون حفظ
- `--force`: إجبار تحديث الإنذارات الموجودة

### إدارة الإنذارات

#### عرض الإنذارات:
- **القائمة الرئيسية**: عرض جميع الإنذارات مع فلترة وبحث
- **التفاصيل**: معلومات شاملة عن كل إنذار
- **الإحصائيات**: عدادات سريعة للحالات المختلفة

#### تحديث حالة الإنذار:
1. افتح تفاصيل الإنذار
2. اختر الحالة الجديدة من القائمة المنسدلة
3. أضف ملاحظات (اختياري)
4. اضغط **تحديث الحالة**

#### الإجراءات المجمعة:
- تحديد عدة إنذارات
- تغيير الحالة لجميع المحددة
- حذف الإنذارات غير المرغوب فيها

### طباعة الإنذارات

#### الطباعة الفردية:
1. افتح تفاصيل الإنذار
2. اضغط **طباعة الإنذار**
3. ستفتح نافذة جديدة بتنسيق قابل للطباعة

#### محتوى الإنذار المطبوع:
- **رأس الصفحة**: شعار وبيانات الشركة
- **معلومات الإنذار**: تفاصيل العقد والمستأجر
- **المحتوى الرئيسي**: المبلغ المتأخر والتواريخ
- **الملاحظات القانونية**: النصوص القانونية المطلوبة
- **قسم التوقيعات**: للإدارة والمستأجر
- **التذييل**: معلومات المرجع والطباعة

## الهيكل التقني

### النماذج (Models)

#### PaymentOverdueNotice
```python
- lease: العقد المرتبط
- notice_date: تاريخ الإنذار
- overdue_month/year: الشهر والسنة المتأخرة
- overdue_amount: المبلغ المتأخر
- due_date: تاريخ الاستحقاق الأصلي
- legal_deadline: الموعد النهائي القانوني (30 يوم)
- status: حالة الإنذار
- potential_legal_action: الإجراء القانوني المحتمل
- sent_date: تاريخ الإرسال
- acknowledged_date: تاريخ الاستلام
- resolved_date: تاريخ الحل
- delivery_method: طريقة التسليم
- recipient_signature: توقيع المستلم
- notes: ملاحظات
```

#### NoticeTemplate
```python
- name: اسم القالب
- template_type: نوع القالب
- subject: موضوع الإنذار
- content: محتوى القالب (HTML)
- is_active: نشط أم لا
- legal_compliance_notes: ملاحظات الامتثال القانوني
```

### العروض (Views)

#### PaymentOverdueNoticeListView
- عرض قائمة الإنذارات مع فلترة وبحث
- إحصائيات سريعة
- إجراءات مجمعة

#### PaymentOverdueNoticeDetailView
- تفاصيل الإنذار الكاملة
- الدفعات المرتبطة
- معاينة المحتوى

#### generate_automatic_notices
- معاينة الإنذارات المحتملة
- تنفيذ الإنشاء التلقائي

### الأوامر الإدارية

#### generate_overdue_notices
```bash
# إنشاء إنذارات جديدة
python3 manage.py generate_overdue_notices

# معاينة فقط
python3 manage.py generate_overdue_notices --dry-run

# إجبار التحديث
python3 manage.py generate_overdue_notices --force
```

#### create_default_notice_templates
```bash
# إنشاء قوالب افتراضية
python3 manage.py create_default_notice_templates
```

## القوالب الافتراضية

### 1. قالب إنذار عدم السداد
- **الاستخدام**: للدفعات المتأخرة
- **المتغيرات**: اسم المستأجر، رقم الوحدة، المبلغ، التواريخ
- **المحتوى**: تنبيه رسمي + إجراء مطلوب + ملاحظات قانونية

### 2. قالب إنذار فسخ العقد
- **الاستخدام**: عند عدم الاستجابة للإنذار الأول
- **المحتوى**: تحذير من فسخ العقد + مهلة أخيرة

### 3. قالب إنذار الإخلاء
- **الاستخدام**: الإجراء النهائي قبل الإخلاء الجبري
- **المحتوى**: إنذار نهائي + تاريخ الإخلاء

## الأمان والصلاحيات

### متطلبات الوصول:
- **تسجيل الدخول**: مطلوب
- **صلاحيات الموظفين**: `is_staff = True`
- **الحماية**: CSRF protection على جميع النماذج

### حماية البيانات:
- **التحقق من الصحة**: فحص البيانات المدخلة
- **منع التكرار**: `unique_together` للعقد والشهر/السنة
- **تسجيل الأنشطة**: تتبع التغييرات والتواريخ

## التخصيص

### تعديل القوالب:
1. انتقل إلى لوحة الإدارة
2. **Dashboard** > **Notice Templates**
3. عدّل المحتوى أو أنشئ قوالب جديدة
4. استخدم المتغيرات: `{tenant_name}`, `{unit_number}`, `{amount}`, إلخ

### إضافة حقول جديدة:
1. عدّل نموذج `PaymentOverdueNotice` في `models.py`
2. أنشئ migration جديد
3. حدّث النماذج والعروض
4. عدّل القوالب لعرض الحقول الجديدة

### تخصيص المنطق القانوني:
- عدّل دالة `save()` في النموذج لتغيير حساب المواعيد
- غيّر النصوص القانونية في `get_notice_content()`
- أضف قواعد جديدة في `generate_automatic_notices()`

## استكشاف الأخطاء

### مشاكل شائعة:

#### لا يتم إنشاء إنذارات تلقائية:
- **السبب**: لا توجد دفعات متأخرة لأكثر من شهر
- **الحل**: تحقق من تواريخ الاستحقاق والدفعات

#### خطأ في الطباعة:
- **السبب**: مشكلة في قالب HTML
- **الحل**: تحقق من صحة HTML في القالب

#### مشكلة في الصلاحيات:
- **السبب**: المستخدم ليس موظف
- **الحل**: تأكد من `is_staff = True` للمستخدم

### سجلات النظام:
```python
# في settings.py
LOGGING = {
    'loggers': {
        'dashboard.models': {
            'level': 'DEBUG',
        },
    },
}
```

## التحديثات المستقبلية

### ميزات مقترحة:
- **إرسال تلقائي**: عبر البريد الإلكتروني أو SMS
- **تذكيرات**: قبل انتهاء المواعيد القانونية
- **تقارير**: إحصائيات مفصلة عن الإنذارات
- **تكامل**: مع أنظمة المحاسبة الخارجية

### صيانة دورية:
- **أرشفة**: الإنذارات القديمة المحلولة
- **تنظيف**: حذف البيانات غير المستخدمة
- **تحديث**: النصوص القانونية حسب التغييرات في القانون

## الدعم

للمساعدة أو الاستفسارات:
1. راجع هذا الدليل أولاً
2. تحقق من سجلات النظام
3. تواصل مع فريق التطوير

---

**ملاحظة**: هذا النظام مصمم ليكون متوافقاً مع قوانين سلطنة عمان. يُنصح بمراجعة مستشار قانوني للتأكد من الامتثال الكامل للقوانين المحلية.

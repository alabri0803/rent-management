# 🚨 دليل نظام إنذارات عدم السداد الشامل

## 🎯 نظرة عامة

نظام متكامل لإدارة إنذارات تأخير السداد يشمل:
- ✅ **إنذارات عدم السداد** - للعقود التي لديها دفعات متأخرة أكثر من 30 يوم
- ⚠️ **إنذارات تأخير التجديد** - للعقود المنتهية بدون تجديد
- 💬 **رسائل تذكير التجديد** - للعقود القريبة من الانتهاء
- 📄 **مستندات PDF** - إنذارات رسمية قابلة للطباعة

---

## 🔄 آلية العمل الكاملة

### 1️⃣ **إنذارات عدم السداد (Payment Overdue Notices)**

#### متى تُنشأ:
- عند وجود دفعات متأخرة **30 يوم أو أكثر**
- للعقود **النشطة** أو **المنتهية** أو **القريبة من الانتهاء**

#### ما يتم إنشاؤه:
- ✅ **PaymentOverdueNotice** - إنذار رئيسي في قاعدة البيانات
- ✅ **PaymentOverdueDetail** - تفاصيل كل شهر متأخر
- ✅ **محتوى HTML** - إنذار رسمي بطلب السداد
- ✅ **تاريخ قانوني** - موعد نهائي 30 يوم (قانون عمان)

#### البيانات المتضمنة:
```
- رقم العقد
- المستأجر
- الوحدة
- عدد الشهور المتأخرة (مثال: 12 شهر)
- إجمالي المبلغ (مثال: 4,200 ر.ع)
- تفاصيل كل شهر (التاريخ، المبلغ، أيام التأخير)
- الموعد النهائي القانوني
- التحذيرات القانونية
```

#### الحالات المتاحة:
- **draft** - مسودة (تم الإنشاء، جاهز للمراجعة)
- **sent** - تم الإرسال
- **acknowledged** - تم الاستلام
- **resolved** - تم الحل (تم السداد)
- **escalated** - تم التصعيد (إجراءات قانونية)

---

### 2️⃣ **إنذارات تأخير التجديد**

#### متى تُنشأ:
- للعقود **المنتهية** لأكثر من **3 أشهر**

#### ما يتم إنشاؤه:
- 📢 **Notification** للمستأجر
- 📢 **Notification** للموظفين
- 📄 **PDF** إنذار تأخير تجديد العقد

---

### 3️⃣ **رسائل تذكير التجديد**

#### متى تُرسل:
- **الشهر الأخير قبل الانتهاء** (expiring_soon)
- **خلال 3 أشهر من الانتهاء** (expired 0-3 months)

#### ما يتم إنشاؤه:
- 💬 **Notification**: "هل لديك رغبة في تجديد العقد؟"
- 📝 **LeaseRenewalReminder** في قاعدة البيانات

---

## 🛠️ أوامر التشغيل

### ⚡ الأمر الشامل الكامل (موصى به بشدة)
```bash
# اختبار (معاينة فقط)
python manage.py process_lease_notifications --dry-run

# تنفيذ فعلي
python manage.py process_lease_notifications
```

**ما يفعله:**
1. ✅ **تحديث حالات العقود** (active, expired, expiring_soon)
2. ✅ **فحص العقود المنتهية** وإنشاء إشعارات تأخير التجديد
3. ✅ **إنشاء إنذارات عدم السداد** للدفعات المتأخرة
4. ✅ **إنشاء تذكيرات التجديد** للعقود القريبة من الانتهاء

---

### 🚨 إنشاء إنذارات عدم السداد فقط
```bash
# اختبار
python manage.py generate_overdue_notices --dry-run

# تنفيذ
python manage.py generate_overdue_notices
```

**المدخلات:**
- يبحث في العقود **النشطة + المنتهية + القريبة من الانتهاء**
- يفحص الدفعات المتأخرة **30 يوم أو أكثر**

**المخرجات:**
```
عدد العقود (النشطة والمنتهية): 3

سيتم إنشاء إنذار: 21053/2024
  المستأجر: مسار للتنمية والتدريب
  الوحدة: ٤١
  عدد الشهور المتأخرة: 12
  إجمالي المبلغ: 4200.00 ر.ع
```

---

### 📅 فحص العقود المنتهية
```bash
python manage.py check_expired_leases
```

**ما يفعله:**
- رسائل تجديد للعقود المنتهية حديثاً (0-3 أشهر)
- إنذارات تأخير للعقود المنتهية لأكثر من 3 أشهر
- مستندات PDF للإنذارات

---

### 📝 تحديث حالات العقود
```bash
python manage.py update_lease_statues
```

**ما يفعله:**
- يحدّث حالة كل عقد حسب `end_date`:
  - `active` - ما زال نشط
  - `expiring_soon` - آخر شهر قبل الانتهاء
  - `expired` - منتهي

---

## 📊 مثال كامل على العقد 21053/2024

### معلومات العقد:
```
رقم العقد: 21053/2024
المستأجر: مسار للتنمية والتدريب
الوحدة: ٤١
الإيجار الشهري: 350 ر.ع
الحالة: expired (منتهي منذ 6 أشهر و 25 يوم)
```

### الدفعات المتأخرة:
```
عدد الشهور المتأخرة: 12 شهر
إجمالي المبلغ: 4,200 ر.ع (12 × 350)
أقدم دفعة متأخرة: منذ أكثر من 30 يوم ✓
```

### ما تم إنشاؤه:
```
✅ إنذار عدم السداد (PaymentOverdueNotice)
   - التاريخ: 2025-10-22
   - الحالة: draft (مسودة)
   - الشهور: 12
   - المبلغ: 4,200 ر.ع
   - الموعد النهائي: 2025-11-21 (30 يوم)

✅ تفاصيل الشهور (PaymentOverdueDetail)
   - 12 سجل، كل شهر بمبلغه وتاريخه

✅ محتوى HTML رسمي
   - جدول بالشهور والمبالغ
   - إجمالي المبلغ المطلوب
   - التحذيرات القانونية
   - الموعد النهائي

✅ إشعار تأخير التجديد (Notification)
   - للمستأجر: "إنذار: تأخير في تجديد العقد"
   - للموظفين: "تنبيه: عقد متأخر في التجديد"

✅ مستند PDF
   - إنذار تأخير تجديد عقد - 21053/2024.pdf
```

---

## 📍 كيفية الوصول للإنذارات

### 1️⃣ **من صفحة تفاصيل العقد:**
```
/dashboard/leases/<lease_id>/
```

**الأزرار المتاحة:**
- 🚨 **إشعار تأخير السداد** - إذا كان لديه دفعات متأخرة
- 📋 **إنذارات العقد (عدد)** - إذا كان لديه إنذارات موجودة

---

### 2️⃣ **من قائمة الإنذارات الشاملة:**
```
/dashboard/overdue-notices/
```

**الفلترة:**
- حسب العقد: `?lease=<lease_id>`
- حسب الحالة: `?status=draft|sent|acknowledged|resolved`

---

### 3️⃣ **من القائمة الجانبية:**
```
المالية → 🚨 إنذارات عدم السداد
```

---

## 🔔 الإشعارات المُنشأة

### للمستأجرين:

| الحالة | النوع | الرسالة |
|--------|------|---------|
| **Expiring Soon** | 💬 تذكير | "هل لديك رغبة في تجديد عقد الإيجار رقم {X}؟" |
| **Expired (0-3 months)** | 💬 تذكير | "عقد الإيجار رقم {X} انتهى. هل ترغب في تجديده؟" |
| **Expired (3+ months)** | ⚠️ إنذار | "إنذار: تأخير في تجديد عقد الإيجار رقم {X}" |
| **Overdue Payments** | 🚨 إنذار | يتم عرضه في صفحة الإنذارات |

### للموظفين:

| الحالة | النوع | الرسالة |
|--------|------|---------|
| **Expired (3+ months)** | 📢 تنبيه | "تنبيه: عقد {X} متأخر في التجديد لمدة {Y} شهر" |

---

## 📄 المستندات المُنشأة

### 1. **إنذار عدم السداد** (في قاعدة البيانات):
- **الموقع:** جدول `PaymentOverdueNotice`
- **العرض:** `/dashboard/overdue-notices/`
- **التفاصيل:** `/dashboard/overdue-notices/<id>/`
- **الطباعة:** زر "طباعة الإنذار" في صفحة التفاصيل

### 2. **PDF إنذار تأخير التجديد**:
- **الموقع:** `media/documents/`
- **اسم الملف:** `overdue_renewal_{contract_number}.pdf`
- **الارتباط:** مرتبط بالعقد في جدول `Document`
- **العرض:** قسم "المستندات" في صفحة تفاصيل العقد

---

## 🎨 واجهة المستخدم

### صفحة قائمة الإنذارات:
```
🚨 إنذارات عدم السداد

📊 إحصائيات سريعة:
  • إجمالي الإنذارات: 3
  • في المسودة: 2
  • تم الإرسال: 1
  • إجمالي المبالغ: 6,300 ر.ع

🔍 البحث والفلترة:
  • بحث برقم العقد أو المستأجر
  • فلترة حسب الحالة
  • فلترة حسب العقد

📋 جدول الإنذارات:
  • العقد
  • المستأجر
  • عدد الشهور
  • إجمالي المبلغ
  • الحالة (بألوان مميزة)
  • الإجراءات
```

### صفحة تفاصيل الإنذار:
```
🚨 إنذار عدم السداد - 21053/2024

📋 معلومات الإنذار:
  • تاريخ الإنذار: 22/10/2025
  • الموعد النهائي القانوني: 21/11/2025 (29 يوم متبقي)
  • الحالة: مسودة
  • عدد الشهور: 12
  • إجمالي المبلغ: 4,200 ر.ع

📊 تفاصيل الشهور المتأخرة:
  [جدول بـ 12 شهر مع التواريخ والمبالغ]

🎬 الإجراءات المتاحة:
  • 📧 تحديث الحالة
  • 🖨️ طباعة الإنذار
  • ↩️ العودة للقائمة
```

---

## ⏰ الجدولة التلقائية

### استخدام Cron (موصى به):
```bash
# افتح ملف crontab
crontab -e

# أضف هذا السطر (التشغيل يومياً الساعة 9 صباحاً)
0 9 * * * cd /Users/macboocair/rent-management && /usr/bin/python3 manage.py process_lease_notifications >> /var/log/lease_notifications.log 2>&1
```

### مثال: التشغيل كل 6 ساعات
```bash
0 */6 * * * cd /Users/macboocair/rent-management && /usr/bin/python3 manage.py process_lease_notifications
```

---

## 🐛 حل المشاكل

### المشكلة: لا تظهر إنذارات للعقد المنتهي
**السبب:** كان الأمر يبحث فقط عن العقود النشطة

**الحل المطبق:**
```python
# في generate_overdue_notices.py
# قبل: status='active'
# بعد: status__in=['active', 'expired', 'expiring_soon']
```

**التحقق:**
```bash
python manage.py generate_overdue_notices --dry-run
```

---

### المشكلة: "لا توجد إنذارات" في صفحة العقد
**الحلول:**

1. **تحديث حالات العقود:**
```bash
python manage.py update_lease_statues
```

2. **إنشاء الإنذارات:**
```bash
python manage.py generate_overdue_notices
```

3. **التحقق من قاعدة البيانات:**
```bash
python manage.py shell -c "from dashboard.models import Lease; lease = Lease.objects.get(contract_number='21053/2024'); print(f'عدد الإنذارات: {lease.overdue_notices.count()}')"
```

4. **الوصول المباشر:**
```
/dashboard/overdue-notices/?lease=<lease_id>
```

---

## ✅ قائمة التحقق الكاملة

عند إعداد نظام جديد:

- [ ] تطبيق Migrations
- [ ] تشغيل `update_lease_statues`
- [ ] تشغيل `generate_overdue_notices`
- [ ] تشغيل `check_expired_leases`
- [ ] إعداد Cron Job
- [ ] اختبار صفحة القائمة
- [ ] اختبار صفحة التفاصيل
- [ ] اختبار الطباعة
- [ ] التحقق من الإشعارات

---

## 📈 الإحصائيات

### بعد تشغيل النظام الكامل:
```
✅ إجمالي الإنذارات في النظام: 3
   • في المسودة: 2
   • تم الإرسال: 1

✅ إجمالي المبالغ المتأخرة: 6,300 ر.ع

✅ العقود المتأثرة: 3
   • نشطة: 2
   • منتهية: 1
```

---

## 📞 الدعم

### الأوامر المفيدة للتشخيص:

```bash
# فحص عقد محدد
python manage.py shell -c "from dashboard.models import Lease; lease = Lease.objects.get(contract_number='21053/2024'); print(f'الحالة: {lease.status}'); print(f'الإنذارات: {lease.overdue_notices.count()}')"

# فحص الدفعات المتأخرة
python manage.py shell -c "from dashboard.models import Lease; lease = Lease.objects.get(contract_number='21053/2024'); summary = lease.get_payment_summary(); overdue = [m for m in summary if m['status'] == 'overdue']; print(f'عدد الشهور المتأخرة: {len(overdue)}')"

# إعادة إنشاء إنذار
python manage.py generate_overdue_notices --force
```

---

**تم التحديث:** 22 أكتوبر 2025
**الإصدار:** 2.0 (شامل العقود المنتهية)
**الحالة:** ✅ جاهز للإنتاج الكامل

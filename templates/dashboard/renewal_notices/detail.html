{% extends "dashboard/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "تفاصيل رسالة التجديد" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- رأس الصفحة -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="مسار التنقل">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard_home' %}">الرئيسية</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'renewal_notices_list' %}">رسائل التجديد</a></li>
                            <li class="breadcrumb-item active">تفاصيل الرسالة</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-0">تفاصيل رسالة التجديد</h1>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'renewal_notice_print_view' notice.pk %}" class="btn btn-primary" target="_blank">
                        <i class="fas fa-print"></i> طباعة الرسالة
                    </a>
                    <a href="{% url 'renewal_notices_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> العودة للقائمة
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- معلومات الرسالة -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">معلومات الرسالة</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-hashtag text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">رقم العقد</label>
                                    <p class="mb-0">
                                        <a href="{% url 'lease_detail' notice.lease.pk %}" class="text-decoration-none">
                                            {{ notice.lease.contract_number }}
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-user text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">المستأجر</label>
                                    <p class="mb-0">
                                        <a href="{% url 'tenant_detail' notice.lease.tenant.pk %}" class="text-decoration-none">
                                            {{ notice.lease.tenant.name }}
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-building text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">الوحدة</label>
                                    <p class="mb-0">{{ notice.lease.unit.unit_number }} - {{ notice.lease.unit.building.name }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-calendar-alt text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">تاريخ التذكير</label>
                                    <p class="mb-0">{{ notice.reminder_date|date:"d F Y" }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-clock text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">تاريخ الانتهاء</label>
                                    <p class="mb-0">{{ notice.expiry_date|date:"d F Y" }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex">
                                <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
                                <div>
                                    <label class="form-label fw-bold">حالة الرسالة</label>
                                    <p class="mb-0">
                                        <span class="badge {% if notice.status == 'draft' %}bg-secondary{% elif notice.status == 'sent' %}bg-success{% elif notice.status == 'responded' %}bg-info{% elif notice.status == 'no_response' %}bg-warning{% else %}bg-light text-dark{% endif %}">
                                            {{ notice.get_status_display }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- محتوى الرسالة -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">محتوى الرسالة</h5>
                </div>
                <div class="card-body">
                    <div class="message-content" style="text-align: right; font-family: 'Traditional Arabic', Arial, sans-serif; direction: rtl;">
                        {{ notice.get_notice_content|safe }}
                    </div>
                </div>
            </div>
        </div>

        <!-- لوحة جانبية -->
        <div class="col-lg-4">
            <!-- معلومات التوقيت -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">معلومات التوقيت</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">الأيام المتبقية للتذكير</label>
                        <p class="mb-0">
                            {% if days_until_reminder > 0 %}
                            <span class="badge bg-info">{{ days_until_reminder }} يوم</span>
                            {% else %}
                            <span class="badge bg-success">مستحقة للإرسال</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">الأيام المتبقية للانتهاء</label>
                        <p class="mb-0">
                            {% if days_until_expiry > 0 %}
                            <span class="badge bg-warning">{{ days_until_expiry }} يوم</span>
                            {% else %}
                            <span class="badge bg-danger">انتهت اليوم</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- حالة الرد -->
            {% if notice.status == 'sent' or notice.status == 'responded' %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">حالة الرد</h5>
                </div>
                <div class="card-body">
                    {% if notice.tenant_response %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">رد المستأجر</label>
                        <p class="mb-0">
                            <span class="badge bg-info">{{ notice.get_tenant_response_display }}</span>
                        </p>
                    </div>
                    {% if notice.response_date %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">تاريخ الرد</label>
                        <p class="mb-0">{{ notice.response_date|date:"d F Y H:i" }}</p>
                    </div>
                    {% endif %}
                    {% if notice.response_notes %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">ملاحظات الرد</label>
                        <p class="mb-0">{{ notice.response_notes }}</p>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">لم يتم الرد بعد</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- معلومات الإرسال -->
            {% if notice.sent_date %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">معلومات الإرسال</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">تاريخ الإرسال</label>
                        <p class="mb-0">{{ notice.sent_date|date:"d F Y H:i" }}</p>
                    </div>
                    {% if notice.delivery_method %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">طريقة التسليم</label>
                        <p class="mb-0">{{ notice.delivery_method }}</p>
                    </div>
                    {% endif %}
                    {% if notice.read_date %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">تاريخ القراءة</label>
                        <p class="mb-0">{{ notice.read_date|date:"d F Y H:i" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- الإجراءات -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">الإجراءات</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if notice.status == 'draft' %}
                        <button type="button" class="btn btn-success" onclick="markAsSent()">
                            <i class="fas fa-paper-plane"></i> تحديد كـ مرسلة
                        </button>
                        {% endif %}

                        {% if notice.status == 'sent' %}
                        <button type="button" class="btn btn-info" onclick="updateResponse()">
                            <i class="fas fa-reply"></i> تحديث الرد
                        </button>
                        {% endif %}

                        <a href="{% url 'lease_detail' notice.lease.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-file-contract"></i> عرض العقد
                        </a>

                        <a href="{% url 'tenant_detail' notice.lease.tenant.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-user"></i> عرض المستأجر
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تحديث الرد -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'renewal_notice_update_response' notice.pk %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">تحديث رد المستأجر</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">رد المستأجر</label>
                        <select name="response" class="form-select" required>
                            <option value="">اختر الرد</option>
                            {% for value, label in response_choices %}
                            <option value="{{ value }}" {% if notice.tenant_response == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ملاحظات (اختياري)</label>
                        <textarea name="notes" class="form-control" rows="3">{{ notice.response_notes }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function markAsSent() {
    if (confirm('هل أنت متأكد من تحديد هذه الرسالة كـ مرسلة؟')) {
        fetch('{% url "renewal_notice_detail" notice.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=mark_sent'
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function updateResponse() {
    new bootstrap.Modal(document.getElementById('responseModal')).show();
}
</script>
{% endblock %}

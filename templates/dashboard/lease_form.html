{% extends 'dashboard/base.html' %}
{% load i18n %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="mb-6"><a href="{% url 'lease_list' %}" class="text-blue-600 hover:underline">&larr; {% trans "العودة إلى قائمة العقود" %}</a></div>
<div class="card max-w-4xl mx-auto p-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h2>
    <style>
        /* Lease form scoped styles */
        .form-lease p { margin: 0; }
        .form-lease p + p { margin-top: 1rem; }
        .form-lease label { display: block; font-size: .9rem; font-weight: 600; color: #374151; margin-bottom: .25rem; }
        .form-lease input[type="text"],
        .form-lease input[type="number"],
        .form-lease input[type="date"],
        .form-lease input[type="email"],
        .form-lease input[type="tel"],
        .form-lease select,
        .form-lease textarea {
            width: 100%;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: .5rem; /* rounded */
            padding: .625rem .75rem; /* 10px 12px */
            background: #fff;
            color: #111827; /* gray-900 */
        }
        .form-lease input:focus,
        .form-lease select:focus,
        .form-lease textarea:focus {
            outline: none;
            border-color: #993333;
            box-shadow: 0 0 0 3px rgba(153,51,51,.15);
        }
        .form-lease .helptext { display: block; margin-top: .25rem; font-size: .75rem; color: #6b7280; }
        .form-lease .errorlist { margin-top: .25rem; color: #b91c1c; font-size: .8rem; }
    </style>
    <!-- Flatpickr date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    <form method="post" enctype="multipart/form-data" class="form-lease">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {{ form.as_p }}
        </div>
        <!-- Live total widget -->
        <div class="mt-4 p-4 border rounded-lg bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">{% trans "المجموع (مبلغ الإيجار × 3٪ × 12 + 1 + 5)" %}</div>
                <div class="text-xl font-bold text-gray-900"><span id="lease-total">0.00</span> {% trans "ر.ع" %}</div>
            </div>
            <div class="text-xs text-gray-500 mt-1">{% trans "يتم التحديث تلقائياً عند إدخال مبلغ الإيجار" %}</div>
        </div>
        <div class="mt-8">
            <button type="submit" class="btn-primary w-full py-3 rounded-lg font-semibold">
                {% if form.instance.pk %}{% trans "حفظ التعديلات" %}{% else %}{% trans "حفظ" %}{% endif %}
            </button>
        </div>
    </form>
    <script>
        (function() {
            if (window.flatpickr) {
                const opts = {
                    dateFormat: 'd/m/Y',
                    altInput: true,
                    altFormat: 'd/m/Y',
                    allowInput: true,
                    locale: flatpickr.l10ns.ar,
                    disableMobile: false
                };
                try { flatpickr("input[name='start_date']", opts); } catch(e){}
                try { flatpickr("input[name='end_date']", opts); } catch(e){}
            }
            // Live total calculator
            function parseNumber(val){
                if (val == null) return 0;
                // remove non-digit/decimal separators
                val = (""+val).replace(/[^0-9.,-]/g, '').replace(',', '.');
                var n = parseFloat(val);
                return isNaN(n) ? 0 : n;
            }
            function formatNumber(n){
                try { return (Math.round(n * 100) / 100).toFixed(2); } catch(e){ return '0.00'; }
            }
            function updateTotal(){
                var rentInput = document.querySelector("input[name='monthly_rent']");
                var out = document.getElementById('lease-total');
                if (!rentInput || !out) return;
                var rent = parseNumber(rentInput.value);
                var total = (rent * 0.03 * 12) + 1 + 5;
                out.textContent = formatNumber(total);
            }
            document.addEventListener('input', function(e){
                if (e.target && e.target.matches("input[name='monthly_rent']")) updateTotal();
            });
            document.addEventListener('change', function(e){
                if (e.target && e.target.matches("input[name='monthly_rent']")) updateTotal();
            });
            // init on load
            updateTotal();
        })();
    </script>
</div>
{% endblock %}
{% extends 'dashboard/base.html' %}
{% load i18n %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 py-8">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-600 rounded-full mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ title }}</h1>
            <p class="text-gray-600">{% trans "أضف عقد إيجار جديد بسهولة وسرعة" %}</p>
        </div>

        <!-- Navigation Breadcrumb -->
        <div class="flex items-center justify-center mb-8">
            <nav class="flex items-center space-x-2 bg-white rounded-full px-6 py-3 shadow-lg">
                <a href="{% url 'lease_list' %}" class="flex items-center text-purple-600 hover:text-purple-800 transition-colors">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    {% trans "العودة إلى قائمة العقود" %}
                </a>
            </nav>
        </div>

        <!-- Main Form Card -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Card Header -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    {% trans "معلومات العقد الجديد" %}
                </h2>
            </div>
    <style>
        /* Lease form scoped styles */
        .form-lease p { margin: 0; }
        .form-lease p + p { margin-top: 1rem; }
        .form-lease label { display: block; font-size: .9rem; font-weight: 600; color: #374151; margin-bottom: .25rem; }
        .form-lease input[type="text"],
        .form-lease input[type="number"],
        .form-lease input[type="date"],
        .form-lease input[type="email"],
        .form-lease input[type="tel"],
        .form-lease select,
        .form-lease textarea {
            width: 100%;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: .5rem; /* rounded */
            padding: .625rem .75rem; /* 10px 12px */
            background: #fff;
            color: #111827; /* gray-900 */
        }
        .form-lease input:focus,
        .form-lease select:focus,
        .form-lease textarea:focus {
            outline: none;
            border-color: #993333;
            box-shadow: 0 0 0 3px rgba(153,51,51,.15);
        }
        .form-lease .helptext { display: block; margin-top: .25rem; font-size: .75rem; color: #6b7280; }
        .form-lease .errorlist { margin-top: .25rem; color: #b91c1c; font-size: .8rem; }
    </style>
    <!-- Flatpickr date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    <form method="post" enctype="multipart/form-data" class="form-lease">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {{ form.as_p }}
        </div>
        <!-- Live total widget -->
        <div class="mt-4 p-4 border rounded-lg bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">{% trans "المجموع (مبلغ الإيجار × 3٪ × 12 + 1 + 5)" %}</div>
                <div class="text-xl font-bold text-gray-900"><span id="lease-total">0.00</span> {% trans "ر.ع" %}</div>
            </div>
            <div class="text-xs text-gray-500 mt-1">{% trans "يتم التحديث تلقائياً عند إدخال مبلغ الإيجار" %}</div>
        </div>
        <div class="mt-8">
            <button type="submit" class="btn-primary w-full py-3 rounded-lg font-semibold">
                {% if form.instance.pk %}{% trans "حفظ التعديلات" %}{% else %}{% trans "حفظ" %}{% endif %}
            </button>
        </div>
    </form>
    <script>
        (function() {
            if (window.flatpickr) {
                // تحديد اللغة بناءً على اللغة الحالية للصفحة
                const currentLang = document.documentElement.lang || 'ar';
                const isArabic = currentLang === 'ar';
                
                const opts = {
                    dateFormat: 'Y-m-d',
                    altInput: true,
                    altFormat: isArabic ? 'd/m/Y' : 'M d, Y',
                    allowInput: true,
                    locale: isArabic ? flatpickr.l10ns.ar : flatpickr.l10ns.default,
                    disableMobile: false
                };
                try { flatpickr("input[name='start_date']", opts); } catch(e){}
                try { flatpickr("input[name='end_date']", opts); } catch(e){}
            }
            // Live total calculator
            function parseNumber(val){
                if (val == null) return 0;
                // remove non-digit/decimal separators
                val = (""+val).replace(/[^0-9.,-]/g, '').replace(',', '.');
                var n = parseFloat(val);
                return isNaN(n) ? 0 : n;
            }
            function formatNumber(n){
                try { return (Math.round(n * 100) / 100).toFixed(2); } catch(e){ return '0.00'; }
            }
            function updateTotal(){
                var rentInput = document.querySelector("input[name='monthly_rent']");
                var out = document.getElementById('lease-total');
                if (!rentInput || !out) return;
                var rent = parseNumber(rentInput.value);
                var total = (rent * 0.03 * 12) + 1 + 5;
                out.textContent = formatNumber(total);
            }
            document.addEventListener('input', function(e){
                if (e.target && e.target.matches("input[name='monthly_rent']")) updateTotal();
            });
            document.addEventListener('change', function(e){
                if (e.target && e.target.matches("input[name='monthly_rent']")) updateTotal();
            });
            // init on load
            updateTotal();
        })();
    </script>
</div>
{% endblock %}
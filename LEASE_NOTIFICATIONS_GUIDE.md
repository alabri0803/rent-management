# 📋 دليل نظام إشعارات وإنذارات العقود

## 🎯 نظرة عامة

نظام تلقائي شامل لإدارة إشعارات وإنذارات عقود الإيجار، يتعامل مع:
- ✅ رسائل تذكير التجديد
- ⚠️ إنذارات تأخير التجديد
- 📄 إنشاء مستندات PDF تلقائية
- 🔔 إشعارات للمستأجرين والموظفين

---

## 🔄 آلية العمل

### 1️⃣ **العقود القريبة من الانتهاء (Expiring Soon)**
**المدة:** شهر واحد قبل الانتهاء

**الإجراءات التلقائية:**
- 📧 إشعار: "عقد الإيجار الخاص بك رقم {X} سينتهي قريب"
- 💬 رسالة: "هل لديك رغبة في تجديد عقد الإيجار رقم {X}؟"

**متى تُرسل:**
- عند تحديث حالة العقد إلى `expiring_soon` (تلقائياً)
- عند تشغيل أمر `update_lease_statues`

---

### 2️⃣ **العقود المنتهية حديثاً (0-3 أشهر)**
**المدة:** من تاريخ الانتهاء حتى 3 أشهر

**الإجراءات التلقائية:**
- 💬 رسالة: "عقد الإيجار رقم {X} انتهى في {تاريخ}. هل ترغب في تجديده؟"

**متى تُرسل:**
- عند تحديث حالة العقد إلى `expired` (تلقائياً)
- عند تشغيل أمر `check_expired_leases`

---

### 3️⃣ **العقود المنتهية بتأخير (3+ أشهر)**
**المدة:** بعد 3 أشهر من الانتهاء

**الإجراءات التلقائية:**
- ⚠️ إنذار للمستأجر: "إنذار: تأخير في تجديد عقد الإيجار رقم {X}"
- 📢 تنبيه للموظفين: "تنبيه: عقد {X} متأخر في التجديد"
- 📄 **PDF رسمي**: "إنذار تأخير تجديد عقد - {X}"

**متى تُرسل:**
- عند تحديث حالة العقد إلى `expired` (تلقائياً)
- عند تشغيل أمر `check_expired_leases`

---

## 🛠️ أوامر التشغيل

### ⚡ الأمر الشامل (موصى به)
```bash
# اختبار بدون تطبيق فعلي
python manage.py process_lease_notifications --dry-run

# تنفيذ فعلي
python manage.py process_lease_notifications
```

**ما يفعله:**
1. تحديث حالات جميع العقود
2. فحص العقود المنتهية وإنشاء الإشعارات
3. إنشاء تذكيرات التجديد للعقود القريبة

---

### 🔍 فحص العقود المنتهية فقط
```bash
# اختبار
python manage.py check_expired_leases --dry-run

# تنفيذ
python manage.py check_expired_leases
```

**ما يفعله:**
- يفحص جميع العقود المنتهية
- يُنشئ الإشعارات المناسبة حسب مدة الانتهاء
- يُنشئ ملفات PDF للإنذارات (بعد 3 أشهر)

---

### 📅 تحديث حالات العقود
```bash
python manage.py update_lease_statues
```

**ما يفعله:**
- يحدث حالة كل عقد حسب تاريخ الانتهاء:
  - `active` → نشط
  - `expiring_soon` → قرب الانتهاء (آخر شهر)
  - `expired` → منتهي

---

### 📝 إنشاء تذكيرات التجديد
```bash
# اختبار
python manage.py generate_renewal_reminders --dry-run

# تنفيذ
python manage.py generate_renewal_reminders
```

**ما يفعله:**
- يُنشئ تذكيرات للعقود التي ستنتهي خلال 30 يوم
- يحفظها في جدول `LeaseRenewalReminder`

---

## ⏰ الجدولة التلقائية

### استخدام Cron (Linux/Mac)
```bash
# افتح ملف crontab
crontab -e

# أضف هذا السطر للتشغيل يومياً الساعة 9 صباحاً
0 9 * * * cd /path/to/rent-management && /path/to/python manage.py process_lease_notifications >> /var/log/lease_notifications.log 2>&1
```

### مثال آخر: التشغيل كل 6 ساعات
```bash
0 */6 * * * cd /path/to/rent-management && /path/to/python manage.py process_lease_notifications
```

---

## 📊 مثال على الإخراج

```
================================================================================
🚀 نظام معالجة إشعارات وإنذارات العقود الشامل
================================================================================

📋 الخطوة 1: تحديث حالات العقود...
--------------------------------------------------------------------------------
  - Lease 21053/2024 status updated to منتهي
✅ تم تحديث حالات العقود بنجاح

📋 الخطوة 2: فحص العقود المنتهية وإنشاء الإشعارات...
--------------------------------------------------------------------------------
🔍 فحص العقود المنتهية بتاريخ 2025-10-22

📊 إجمالي العقود المنتهية: 1

📝 العقد: 21053/2024 | انتهى منذ: 6 شهر و 25 يوم
   ✅ تم إرسال: إنذار تأخير للمستأجر
   ✅ تم إنشاء: PDF إنذار تأخير التجديد

📈 ملخص العملية:
  • إجمالي العقود المنتهية: 1
  • رسائل التجديد الجديدة: 0
  • إنذارات التأخير الجديدة: 1
  • ملفات PDF المُنشأة: 1

✅ اكتملت جميع العمليات بنجاح!
```

---

## 🔔 الإشعارات المُنشأة

### للمستأجرين:
| الحالة | النوع | الرسالة |
|--------|------|---------|
| **Expiring Soon** | 📧 إشعار | "عقد الإيجار الخاص بك رقم {X} سينتهي قريب في تاريخ {تاريخ}" |
| **Expiring Soon** | 💬 رسالة تجديد | "هل لديك رغبة في تجديد عقد الإيجار رقم {X}؟ ينتهي في {تاريخ}" |
| **Expired (0-3 months)** | 💬 رسالة تجديد | "عقد الإيجار رقم {X} انتهى في {تاريخ}. هل ترغب في تجديده؟" |
| **Expired (3+ months)** | ⚠️ إنذار | "إنذار: تأخير في تجديد عقد الإيجار رقم {X} لأكثر من {عدد} شهر" |

### للموظفين:
| الحالة | النوع | الرسالة |
|--------|------|---------|
| **Expired (3+ months)** | 📢 تنبيه | "تنبيه: عقد {X} متأخر في التجديد لمدة {عدد} شهر" |

---

## 📄 المستندات المُنشأة

### ملفات PDF التلقائية:
- **إنذار تأخير تجديد عقد** - يُنشأ تلقائياً بعد 3 أشهر من الانتهاء
- **موقع الحفظ:** `media/documents/` (مرتبط بالعقد)
- **اسم الملف:** `overdue_renewal_{contract_number}.pdf`

---

## 🔧 التخصيص

### تغيير مدة الإنذار (من 3 أشهر إلى مدة أخرى):

#### في `signals.py` (السطر 73):
```python
elif months_overdue >= 3:  # غيّر الرقم 3 حسب الحاجة
```

#### في `check_expired_leases.py` (السطر 51):
```python
elif months_overdue >= 3:  # غيّر الرقم 3 حسب الحاجة
```

---

## ✅ الميزات

- ✨ **تلقائي بالكامل** - يعمل عند تحديث حالة العقد
- 🔄 **منع التكرار** - لا يُنشئ إشعارات مكررة
- 📊 **تقارير مفصلة** - إحصائيات شاملة لكل عملية
- 🧪 **وضع الاختبار** - `--dry-run` للمعاينة قبل التنفيذ
- 📄 **PDF احترافي** - إنذارات رسمية بتصميم احترافي
- 🌐 **متعدد اللغات** - دعم العربية والإنجليزية
- 🔐 **آمن** - لا يُعدّل على البيانات، فقط يُنشئ إشعارات

---

## 🐛 حل المشاكل

### المشكلة: لا تظهر إشعارات للعقود المنتهية
**الحل:**
```bash
# 1. تحديث حالات العقود
python manage.py update_lease_statues

# 2. فحص العقود المنتهية
python manage.py check_expired_leases

# أو استخدم الأمر الشامل
python manage.py process_lease_notifications
```

### المشكلة: المستأجر لا يستلم الإشعارات
**الحل:**
- تأكد من وجود حساب مستخدم (`user`) مرتبط بالمستأجر
- تحقق من جدول `Notification` في قاعدة البيانات

### المشكلة: فشل إنشاء PDF
**السبب:** مكتبة `weasyprint` غير مثبتة أو بها مشكلة
**الحل:**
```bash
pip install weasyprint
# أو استخدم البديل
pip install xhtml2pdf
```

---

## 📞 الدعم

للمساعدة أو الاستفسارات، راجع:
- 📖 ملف `signals.py` - للـ signals التلقائية
- 🛠️ مجلد `management/commands/` - لأوامر التشغيل
- 📋 ملف `models.py` - لنماذج البيانات

---

**تم إنشاؤه:** 22 أكتوبر 2025
**الإصدار:** 1.0
**الحالة:** ✅ جاهز للإنتاج

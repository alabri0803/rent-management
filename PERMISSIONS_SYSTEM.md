# 🔐 نظام الصلاحيات الشامل - دليل كامل

## 📋 نظرة عامة

تم إنشاء نظام صلاحيات متقدم ومرن يسمح بالتحكم الدقيق في وصول الموظفين إلى مختلف أجزاء النظام.

---

## 🎯 المميزات الرئيسية

### ✅ **صلاحيات تفصيلية**
- 20 صلاحية منفصلة تغطي جميع جوانب النظام
- إمكانية تخصيص الصلاحيات لكل موظف على حدة
- أدوار محددة مسبقاً للتطبيق السريع

### ✅ **واجهة سهلة الاستخدام**
- واجهة مرئية احترافية لإدارة الصلاحيات
- تطبيق أدوار جاهزة بنقرة واحدة
- تعديل تفصيلي للصلاحيات الفردية

### ✅ **حماية قوية**
- Decorators لحماية الـ Views
- Template tags للتحكم في العرض
- منع الوصول غير المصرح به تلقائياً

---

## 📊 الصلاحيات المتاحة

### 🏢 **إدارة العقارات**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_buildings` | عرض المباني |
| `can_manage_buildings` | إدارة المباني (إضافة، تعديل، حذف) |
| `can_view_units` | عرض الوحدات |
| `can_manage_units` | إدارة الوحدات (إضافة، تعديل، حذف) |

### 📝 **إدارة العقود**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_leases` | عرض العقود |
| `can_manage_leases` | إدارة العقود (إضافة، تعديل، حذف، تجديد، إلغاء) |

### 👥 **إدارة المستأجرين**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_tenants` | عرض المستأجرين |
| `can_manage_tenants` | إدارة المستأجرين (إضافة، تعديل، حذف) |

### 💰 **العمليات المالية**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_payments` | عرض الدفعات |
| `can_manage_payments` | إدارة الدفعات (إضافة، تعديل، حذف) |
| `can_view_invoices` | عرض الفواتير |
| `can_manage_invoices` | إدارة الفواتير (إنشاء، تعديل، حذف) |
| `can_view_expenses` | عرض المصروفات |
| `can_manage_expenses` | إدارة المصروفات (إضافة، تعديل، حذف) |

### ⚠️ **الإنذارات**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_notices` | عرض الإنذارات |
| `can_manage_notices` | إدارة الإنذارات (إنشاء، تعديل، إرسال) |

### 📊 **التقارير**
| الصلاحية | الوصف |
|---------|-------|
| `can_view_reports` | عرض التقارير |
| `can_export_reports` | تصدير التقارير (PDF/Excel) |

### 🔒 **الإدارة**
| الصلاحية | الوصف |
|---------|-------|
| `can_manage_users` | إدارة المستخدمين وصلاحياتهم |
| `can_access_settings` | الوصول إلى إعدادات النظام |

---

## 👔 الأدوار المحددة مسبقاً

### 1️⃣ **مدير عقارات** (`property_manager`)
```
✅ عرض المباني
✅ عرض وإدارة الوحدات
✅ عرض وإدارة العقود
✅ عرض المستأجرين
❌ العمليات المالية
❌ الإنذارات
❌ التقارير
❌ إدارة المستخدمين
```

### 2️⃣ **مدير مالي** (`financial_manager`)
```
✅ عرض المباني والوحدات
✅ عرض العقود والمستأجرين
✅ إدارة كاملة للعمليات المالية
✅ إدارة الإنذارات
✅ عرض وتصدير التقارير
❌ إدارة المستخدمين
```

### 3️⃣ **مدير المستأجرين** (`tenant_manager`)
```
✅ عرض المباني والوحدات
✅ عرض العقود
✅ عرض وإدارة المستأجرين
❌ العمليات المالية
❌ الإنذارات
❌ التقارير
❌ إدارة المستخدمين
```

### 4️⃣ **مشاهد** (`viewer`)
```
✅ عرض جميع البيانات
❌ لا يمكنه التعديل أو الإضافة أو الحذف
❌ لا يمكنه تصدير التقارير
```

---

## 🚀 دليل الاستخدام

### 1. **إدارة صلاحيات مستخدم**

#### الطريقة الأولى: من واجهة المستخدمين
1. اذهب إلى **إدارة المستخدمين**
2. اضغط على أيقونة 🔐 بجانب المستخدم
3. اختر دور محدد مسبقاً أو عدل الصلاحيات يدوياً
4. اضغط **حفظ الصلاحيات**

#### الطريقة الثانية: من خلال URL مباشر
```
/dashboard/users/{user_id}/permissions/
```

### 2. **تطبيق دور محدد**
في صفحة صلاحيات المستخدم، اضغط على أحد الأدوار المحددة مسبقاً:
- مدير عقارات
- مدير مالي
- مدير المستأجرين
- مشاهد

### 3. **تخصيص الصلاحيات**
- حدد الصلاحيات المطلوبة من القائمة
- يمكن الجمع بين صلاحيات متعددة
- احفظ التغييرات

---

## 💻 للمطورين

### استخدام Decorators في Views

#### مثال 1: صلاحية واحدة
```python
from dashboard.decorators import permission_required

@permission_required('can_manage_units')
def add_unit(request):
    # هذا الـ view يتطلب صلاحية إدارة الوحدات
    pass
```

#### مثال 2: أي صلاحية من عدة صلاحيات
```python
from dashboard.decorators import any_permission_required

@any_permission_required('can_view_units', 'can_manage_units')
def unit_list(request):
    # يمكن الوصول بصلاحية عرض أو إدارة
    pass
```

#### مثال 3: جميع الصلاحيات مطلوبة
```python
from dashboard.decorators import all_permissions_required

@all_permissions_required('can_view_payments', 'can_manage_payments')
def payment_operations(request):
    # يتطلب كلا الصلاحيتين
    pass
```

### استخدام Template Tags

#### في القوالب
```django
{% load dashboard_extras %}

<!-- طريقة 1: باستخدام has_permission -->
{% has_permission 'can_manage_units' as can_edit %}
{% if can_edit %}
    <a href="{% url 'unit_create' %}">إضافة وحدة</a>
{% endif %}

<!-- طريقة 2: باستخدام filter -->
{% if request.user|has_perm:'can_manage_units' %}
    <button>تعديل</button>
{% endif %}

<!-- طريقة 3: الوصول لحقل الصلاحية مباشرة -->
{% if profile|get_attr:'can_manage_units' %}
    <button>إدارة</button>
{% endif %}
```

### التحقق في الكود Python
```python
# في الـ View
if request.user.profile.has_permission('can_manage_units'):
    # السماح بالعملية
    pass

# الحصول على جميع الصلاحيات
permissions = request.user.profile.get_all_permissions()
```

---

## 🛠️ أوامر الإدارة

### إعداد الصلاحيات الافتراضية
```bash
# إنشاء profiles للمستخدمين الموجودين
python3 manage.py setup_default_permissions

# تطبيق دور محدد على جميع المستخدمين
python3 manage.py setup_default_permissions --role=property_manager

# إعادة تعيين جميع الصلاحيات
python3 manage.py setup_default_permissions --reset
```

---

## 📝 ملاحظات هامة

### ⚠️ **قواعد مهمة**
1. **المستخدمون الإداريون (Superusers)** لديهم جميع الصلاحيات تلقائياً
2. صلاحية **"العرض"** يجب أن تكون موجودة قبل منح صلاحية **"الإدارة"**
3. يمكن تطبيق دور محدد ثم تعديله حسب الحاجة
4. التغييرات تطبق فوراً على المستخدم

### 🔒 **الأمان**
- جميع Views محمية بـ Decorators
- لا يمكن الوصول إلى صفحة بدون الصلاحية المطلوبة
- رسائل خطأ واضحة عند محاولة الوصول غير المصرح

### 📱 **التوافق**
- يعمل مع جميع المتصفحات الحديثة
- تصميم متجاوب للهواتف والأجهزة اللوحية
- دعم كامل للغتين العربية والإنجليزية

---

## 🎨 مثال عملي

### سيناريو: موظف إدارة عقارات

**المطلوب:**
- يستطيع رؤية جميع المباني والوحدات
- يستطيع إضافة وتعديل الوحدات
- يستطيع إدارة العقود
- **لا** يستطيع رؤية العمليات المالية

**الحل:**
1. اذهب لصفحة صلاحيات الموظف
2. اضغط على "مدير عقارات"
3. أو حدد الصلاحيات يدوياً:
   - ✅ عرض المباني
   - ✅ عرض الوحدات
   - ✅ إدارة الوحدات
   - ✅ عرض العقود
   - ✅ إدارة العقود
   - ✅ عرض المستأجرين

---

## 📂 الملفات المضافة/المعدلة

### ملفات جديدة:
1. `dashboard/decorators.py` - Decorators لحماية الـ Views
2. `dashboard/management/commands/setup_default_permissions.py` - أمر الإعداد
3. `templates/dashboard/user_permissions.html` - واجهة إدارة الصلاحيات

### ملفات معدلة:
1. `dashboard/models.py` - إضافة 20 حقل صلاحية + دوال مساعدة
2. `dashboard/views.py` - إضافة UserPermissionsView
3. `dashboard/urls.py` - إضافة مسار الصلاحيات
4. `dashboard/templatetags/dashboard_extras.py` - Template tags للصلاحيات
5. `templates/dashboard/user_management.html` - زر إدارة الصلاحيات
6. `dashboard/migrations/0007_add_user_permissions.py` - Migration جديد

---

## ✅ خطوات التفعيل

### 1. تطبيق Migration (تم ✅)
```bash
python3 manage.py migrate dashboard
```

### 2. إعداد الصلاحيات للمستخدمين الموجودين
```bash
python3 manage.py setup_default_permissions
```

### 3. تخصيص الصلاحيات
- اذهب لإدارة المستخدمين
- اضغط على 🔐 لكل مستخدم
- اختر الدور المناسب

---

## 🎉 النتيجة النهائية

✅ **نظام صلاحيات متكامل وآمن**
✅ **سهل الاستخدام والإدارة**
✅ **مرن وقابل للتوسع**
✅ **محمي ومؤمن**
✅ **متوافق مع جميع أجزاء النظام**

---

## 📞 الدعم والمساعدة

لأي استفسار أو مشكلة:
1. راجع هذا الدليل أولاً
2. تحقق من أن Migration تم تطبيقه
3. تأكد من تشغيل أمر الإعداد
4. تحقق من الصلاحيات في صفحة المستخدم

---

**تم التطوير بواسطة:** نظام إدارة الإيجارات  
**التاريخ:** 2025  
**الإصدار:** 1.0

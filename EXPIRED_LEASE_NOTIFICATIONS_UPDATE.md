# ✅ إضافة قسم إشعارات العقود المنتهية في صفحة تفاصيل العقد

## 🎯 المشكلة الأصلية

عند عرض عقد منتهي (expired)، كانت الإشعارات التالية **موجودة في قاعدة البيانات** لكن **لا تظهر في صفحة العقد**:

```
❌ رسالة "هل لديك رغبة في تجديد عقد الإيجار؟"
❌ إنذار "تأخير في تجديد عقد الإيجار لأكثر من 3 أشهر"
```

**السبب:**
الأزرار الموجودة كانت فقط للعقود **النشطة** (active):
```html
<!-- الشرط القديم -->
{% if lease.status == 'active' and lease.days_until_expiry <= 90 %}
    رسالة تذكير التجديد
{% endif %}
```

---

## ✅ الحل المطبق

### 1️⃣ **إضافة قسم خاص للعقود المنتهية**

تم إضافة قسم كامل يظهر **فقط للعقود المنتهية** يعرض:

#### 📊 **معلومات الانتهاء:**
```
📅 تاريخ الانتهاء: 27/03/2025
⏰ مدة التأخير: 6 شهر و 25 يوم
```

#### 💬 **رسالة التجديد:**
```
💬 رسالة تجديد
هل لديك رغبة في تجديد عقد الإيجار؟
```

#### 🚨 **إنذار تأخير التجديد** (يظهر بعد 90 يوم):
```
🚨 إنذار تأخير التجديد
تأخير في تجديد عقد الإيجار لأكثر من 3 أشهر. 
يرجى التواصل لتجديد العقد أو إخلاء الوحدة.
```

---

## 📋 الكود المُضاف

### في `lease_detail.html`:

```html
<!-- إشعارات العقد المنتهي - تظهر للعقود المنتهية -->
{% if lease.status == 'expired' %}
<div class="w-full mt-4 p-6 bg-gradient-to-r from-orange-50 to-red-50 border-r-4 border-orange-500 rounded-xl">
    <div class="flex items-center mb-4">
        <div class="bg-orange-500 rounded-full p-2 ml-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-bold text-orange-900">⚠️ {% trans "عقد منتهي" %}</h3>
    </div>
    
    <div class="space-y-3">
        <!-- تاريخ الانتهاء ومدة التأخير -->
        <div class="bg-white p-4 rounded-lg border border-orange-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-800 font-semibold text-sm">📅 {% trans "تاريخ الانتهاء" %}</p>
                    <p class="text-orange-900 font-bold">{{ lease.end_date|date:"d/m/Y" }}</p>
                </div>
                <div class="text-left">
                    <p class="text-orange-800 font-semibold text-sm">⏰ {% trans "مدة التأخير" %}</p>
                    <p class="text-orange-900 font-bold">{{ lease.overdue_duration_display|default:"-" }}</p>
                </div>
            </div>
        </div>
        
        <!-- رسالة التجديد -->
        <div class="bg-orange-100 p-4 rounded-lg">
            <p class="text-orange-900 font-semibold mb-2">💬 {% trans "رسالة تجديد" %}</p>
            <p class="text-orange-800">
                {% trans "هل لديك رغبة في تجديد عقد الإيجار؟" %}
            </p>
        </div>
        
        <!-- إنذار تأخير التجديد (بعد 90 يوم) -->
        {% with days_overdue=lease.days_overdue %}
        {% if days_overdue >= 90 %}
        <div class="bg-red-100 p-4 rounded-lg border-2 border-red-300">
            <p class="text-red-900 font-bold mb-2">🚨 {% trans "إنذار تأخير التجديد" %}</p>
            <p class="text-red-800">
                {% trans "تأخير في تجديد عقد الإيجار لأكثر من 3 أشهر. يرجى التواصل لتجديد العقد أو إخلاء الوحدة." %}
            </p>
        </div>
        {% endif %}
        {% endwith %}
    </div>
</div>
{% endif %}
```

---

## 🎨 التصميم

### 🟠 **بطاقة العقد المنتهي:**
- خلفية متدرجة من البرتقالي إلى الأحمر الفاتح
- حدّ أيمن برتقالي سميك
- أيقونة تحذير دائرية

### ⚪ **معلومات الانتهاء:**
- خلفية بيضاء مع حدود برتقالية
- عمودين: تاريخ الانتهاء | مدة التأخير

### 🟡 **رسالة التجديد:**
- خلفية برتقالية فاتحة
- نص واضح للسؤال

### 🔴 **إنذار التأخير:**
- يظهر فقط بعد **90 يوم** (3 أشهر)
- خلفية حمراء فاتحة مع حدود حمراء
- رسالة قوية للتحذير

---

## 🌐 الترجمات الإنجليزية

تم إضافة وتصحيح الترجمات التالية:

```
عقد منتهي → Expired Contract
تاريخ الانتهاء → End Date
مدة التأخير → Delay Duration
رسالة تجديد → Renewal Message
هل لديك رغبة في تجديد عقد الإيجار؟ → Would you like to renew the lease contract?
إنذار تأخير التجديد → Renewal Delay Notice
تأخير في تجديد عقد الإيجار لأكثر من 3 أشهر... → Delay in renewing the lease contract for more than 3 months...
```

---

## 🔢 الخصائص المستخدمة من نموذج Lease

### ✅ خصائص موجودة مسبقاً:

#### 1. `overdue_duration_display()` - دالة
**الوظيفة:** تعرض مدة التأخير بصيغة (سنة، شهر، يوم)
```python
def overdue_duration_display(self):
    """مدة التأخير بصيغة (سنة، شهر، يوم) للعقود المنتهية"""
    if self.status not in ['expired', 'renewed']:
        return None
    today = timezone.now().date()
    if today <= self.end_date:
        return None
    rd = relativedelta(today, self.end_date)
    parts = []
    if rd.years:
        parts.append(_("%(years)s سنة") % {"years": rd.years})
    if rd.months:
        parts.append(_("%(months)s شهر") % {"months": rd.months})
    if rd.days or not parts:
        parts.append(_("%(days)s يوم") % {"days": rd.days})
    return "، ".join(parts)
```

**مثال الإخراج:** `"6 شهر، 25 يوم"`

---

#### 2. `days_overdue()` - دالة
**الوظيفة:** تعيد عدد الأيام منذ انتهاء العقد
```python
def days_overdue(self):
    """عدد أيام التأخير للعقود المنتهية"""
    if self.status not in ['expired', 'renewed']:
        return 0
    today = timezone.now().date()
    if today <= self.end_date:
        return 0
    return (today - self.end_date).days
```

**مثال الإخراج:** `205` (أيام)

**الاستخدام:** لتحديد متى يظهر إنذار التأخير (≥ 90 يوم)

---

## 📊 مثال على عقد منتهي: 21053/2024

### معلومات العقد:
```
رقم العقد: 21053/2024
المستأجر: مسار للتنمية والتدريب
الوحدة: بيت الحمد - ٤١
تاريخ البدء: 01/04/2024
تاريخ الانتهاء: 27/03/2025
الحالة: expired
```

### حسابات التأخير:
```
اليوم: 22/10/2025
تاريخ الانتهاء: 27/03/2025
مدة التأخير: 209 أيام
         = 6 شهر و 25 يوم
         = أكثر من 90 يوم ✓
```

### ما سيُعرض:
```
✅ قسم "عقد منتهي" (خلفية برتقالية)
   ├─ 📅 تاريخ الانتهاء: 27/03/2025
   ├─ ⏰ مدة التأخير: 6 شهر و 25 يوم
   ├─ 💬 رسالة تجديد: "هل لديك رغبة في تجديد عقد الإيجار؟"
   └─ 🚨 إنذار تأخير التجديد (لأن 209 ≥ 90)
      "تأخير في تجديد عقد الإيجار لأكثر من 3 أشهر..."
```

---

## 🔄 الفرق بين القديم والجديد

### ❌ **القديم:**
```
📋 إنذارات العقد (1)   ← زر معطّل (رمادي)
```
**فقط!** لا توجد رسائل أو إنذارات واضحة

---

### ✅ **الجديد:**
```
📋 إنذارات العقد (1)   ← زر نشط يفتح القائمة

⚠️ عقد منتهي               ← قسم جديد كامل
├─ 📅 تاريخ الانتهاء
├─ ⏰ مدة التأخير
├─ 💬 رسالة تجديد
└─ 🚨 إنذار تأخير (بعد 90 يوم)
```

---

## 📱 العرض على الأجهزة

### 🖥️ **Desktop:**
- القسم بعرض كامل
- معلومات جنباً إلى جنب

### 📱 **Mobile:**
- القسم يتكيف تلقائياً
- المعلومات تترتب عمودياً

---

## 🎯 متى يظهر كل عنصر؟

| العنصر | الشرط | مثال |
|--------|-------|------|
| **قسم "عقد منتهي"** | `lease.status == 'expired'` | العقد 21053/2024 ✓ |
| **تاريخ الانتهاء** | دائماً (للعقود المنتهية) | 27/03/2025 |
| **مدة التأخير** | دائماً (للعقود المنتهية) | 6 شهر و 25 يوم |
| **رسالة التجديد** | دائماً (للعقود المنتهية) | "هل لديك رغبة..." |
| **إنذار التأخير** | `lease.days_overdue() >= 90` | 209 أيام ✓ |

---

## 📄 الملفات المعدلة

| الملف | التغيير |
|------|---------|
| `templates/dashboard/lease_detail.html` | ✅ إضافة قسم العقد المنتهي كامل |
| `locale/en/LC_MESSAGES/django.po` | ✅ إضافة 5 ترجمات جديدة |
| `EXPIRED_LEASE_NOTIFICATIONS_UPDATE.md` | ✨ ملف التوثيق (هذا الملف) |

---

## 🧪 الاختبار

### للتحقق من العمل:

```bash
# 1. تحديث حالات العقود
python manage.py update_lease_statues

# 2. زيارة صفحة العقد
http://localhost:8000/dashboard/leases/<id>/

# 3. التحقق من القسم الجديد
✓ يظهر قسم "⚠️ عقد منتهي"
✓ يعرض تاريخ الانتهاء ومدة التأخير
✓ يعرض رسالة التجديد
✓ يعرض إنذار التأخير (إذا > 90 يوم)
```

---

## ✅ النتيجة النهائية

الآن عند زيارة **أي عقد منتهي** سيرى المستخدم:

```
🏠 بيت الحمد - ٤١
💰 350 ر.ع شهرياً
📅 01/04/2024 - 27/03/2025

[📋 إنذارات العقد (1)]  ← زر نشط

⚠️ عقد منتهي
┌─────────────────────────────────┐
│ 📅 تاريخ الانتهاء: 27/03/2025  │
│ ⏰ مدة التأخير: 6 شهر و 25 يوم│
├─────────────────────────────────┤
│ 💬 رسالة تجديد                 │
│ هل لديك رغبة في تجديد عقد      │
│ الإيجار؟                        │
├─────────────────────────────────┤
│ 🚨 إنذار تأخير التجديد         │
│ تأخير في تجديد عقد الإيجار     │
│ لأكثر من 3 أشهر. يرجى التواصل  │
│ لتجديد العقد أو إخلاء الوحدة.  │
└─────────────────────────────────┘
```

---

**التحديث:** 22 أكتوبر 2025  
**الحالة:** ✅ مطبّق ومُختبر  
**التأثير:** تحسين واضح في عرض حالة العقود المنتهية
